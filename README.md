# Linux Device Driver(LDD) - BMP180
### 목적
  - 취미로 진행하는 LDD를 만들고 있습니다. 실무에서 경험한 내용들과 개인 공부한 내용들을 풀어보려 합니다.
  
### 소개 
  - BMP180은 BOSCH사에 만든 기압 및 온도 센서입니다. 칩자체의 기능이 단순하여 디바이스 드라이버를 직접 구현하기 상당히 수월한 편에 속하는 칩입니다. 
  - 해당 칩에서는 온도와 기압을 측정이 가능합니다.
-----

개발 환경은 다음과 같습니다.
- ### HW
  - **라즈베리파이3 B**
  - **반드시 5V 2A 이상의 어댑터를 사용하세요.** 노트북에 꽂으면서 개발을 진행하면, 언제가 전류가 약해서 죽는 문제를 패닉으로 혹시나 오해하는 상황이 옵니다(라즈베리파이에서는 사실 5V-3A를 사용하라고 권고합니다). 
  
- ### SW
  - **Linux kernel 5.10.103** 
    - 라즈비안 다운로드 시, 커널 버전은 5.10.103이하 라면 어떤 버전을 받든 상관없습니다. 이미지를 받더라도 결국 `sudo apt update & apt upgrade -y`를 통해 가장 stable한 버전으로 업그레이드를 해야합니다. 그 이렇게 번거로운 짓을 하는 이유는 라즈베리파이가 linux-hedaers가 기본적으로 다운로드 되어있지 않기 때문입니다. 모듈 빌드시에는 반드시 /lib/modules/${KERNEL_VERSION}/build/ 폴더가 커널 소스 및 리눅스 커널 헤더를 심볼릭 링크를 하고 있어야 정상적으로 빌드가 됩니다. 그런데 라즈베리파이에서 stable한 커널 버전에서만 linux-headers를 제공하기 때문에, 처음부터 stable한 버전을 받지 않는 이상 업데이트 및 업그레이드는 진행은 반드시 진행을 해야 합니다.
   
- ### DEV
  - **Build** 
    - 라즈베리파이 모듈로 직접 빌드하는 환경을 꾸몄습니다. 소스 자체를 다운받은 것은 아닙니다. linux-heaers-${VERSION}을 자신의 라즈베리파이 버전과 동일하게 맞춰야 빌드가 정상적으로 진행될 것입니다.
    - 크로스 컴파일 환경은 추천하지 않습니다. 이유는 다음과 같습니다.
      1. 라즈베리파이가 속도가 느리더라도, 모듈만 빌드할 경우 결과적으로 실행 결과는 더 빠를 수 있습니다.
      2. 크로스 컴파일로 빌드를 할 경우, module_install 시, /lib/modules/${VERSION}/build 폴더의 심볼릭 링크에 문제가 발생합니다.
  
  - **PC와 라즈베리파이의 연결**
    1. UART - 가장 추천하는 방법입니다. UART를 이용하면 Boot-up 로그까지 모두 볼 수 있습니다.
    2. Ethernet SSH - 나쁘지 않습니다. Boot-up 로그까지 볼 수 있는지는 알아보지 않았지만, Wifi 방법보다는 좋다고 생각됩니다.
    3. Wifi SSH - 위에 2가지 상황이 안될 경우 그나마 해볼 수 있는 상황이 생각됩니다. 해당 방법은 변수가 많아 좋아하지 않습니다(라즈베리파이3의 경우 고질적인 wifi 문제가 있습니다..).
----
### 실습 
RPI3-B Kernel 5.10.103 버전에서 테스트했습니다.
1. PC : bcm2835-rpi.dtsi를 /linux/arch/arm/boot/dts/ 에 복사합니다. devicetree만 빌드해서 SD Card에 write하면 됩니다. SD Card를 꽂고 부팅합니다. 디바이스 트리를 SD Card에 write하는 내용은 `https://www.raspberrypi.com/documentation/computers/linux_kernel.html` 링크를 참고하세요.
2. RPI : 라즈베리파이에서 `git clone https://github.com/yohda/LDD-BMP180.git` 명령어를 원하는 작업 폴더에 입력합니다.
3. RPI : make 입력하여 컴파일을 진행합니다.
4. RPI : 빌드가 성공하면 sudo insmod bmp180.ko를 통해 모듈을 로딩합니다.
5. RPI : 성공할 경우, 아래의 속성들을 확인할 수 있습니다. 
    - /sys/class/hwmon/hwmon3/name -> 이름 출력 (bmp180)
    - /sys/class/hwmon/hwmon3/temp -> 온도 출력
    - /sys/class/hwmon/hwmon3/pres -> 기압 출력

-------------------------------------------------------------------------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------------------------------------
### 개발 과정
1. 제일 먼저 BMP180의 Datasheet에 Operating Voltage를 확인합니다. 1.8V ~ 3.6V이니 라즈베리파이와 호환이 되겠군요.
![image](https://user-images.githubusercontent.com/29424805/216984570-ebd5c360-5f5f-40f4-b591-bb7020bd6637.png)


2. 통신 라인이 어떻게 되는지 봐야합니다. 
![image](https://user-images.githubusercontent.com/29424805/216985261-a0a99894-327e-4f74-b1c5-66be619f5f03.png)
I2C를 사용하는 군요. 근데 여기서 중요한 부분이 Rp로 적힌 풀업 저항입니다. **제가 모듈로 산 이유가 바로 이 부분입니다.**
임베디드 개발자가 회사가 아닌 집에서 개발하는 경우, HW에 대한 부분을 신경쓰지 않고 개발을 하기가 상당히 번거럽고 어렵습니다. 그래서 모듈을 구매해서 **HW에 대한 의존성을 어느 정도 해소했습니다.**


3. 라즈베리파이에서 I2C 스펙을 확인해야 합니다. 브로드컴 BCM2837에서는 3개의 I2C를 지원하는데, 거창하게 BSC라는 용어를 붙혔네요. 주의할 점은 BSC2는 HDMI 전용이라 사용하지 못한다는 것에 유의하세요. 참고로 라즈베리파이에서 raspi-config를 통해 I2C를 활성화하면 default로 BSC1이 활성화됩니다.
![image](https://user-images.githubusercontent.com/29424805/216987818-c51f1282-104b-42c7-926e-abd807eee081.png) 


4. I2C 핀을 확인합니다. GPIO[0,1] , GPIO[2,3], GPIO[28,29]. 아주 많습니다. 물론 이런 핀들은 pin-multiplex를 통해서 GPIO, PWM, UART등 여러 기능으로 사용이 될 수 있습니다.
![image](https://user-images.githubusercontent.com/29424805/216989414-99a719dd-ed32-43d3-b39e-00211ef00dbe.png)


5. 이제 한 번 BMP180에 Power를 넣어줘 봅시다. 라즈베리파이3 B의 핀맵을 봐야합니다. 1번고 17번 핀이 3V3로 사용되는 것이 보이군요. 여기서는 라즈베리파이 핀맵을 보고 위에서는 브로드컴 핀맵을 보는 이유가 뭘까요? 만약 제가 라즈베리파이 핀맵만 보여줬다면 어땟을까요? 처음 보는 사람은 아마 GPIO[2,3]번만 I2C로 사용할 수 있다고 생각할 겁니다. 제가 하고 싶은 말은 **브로드컴의 BCM2837을 가지고 라즈베리파이재단에서 자기네들에게 맞게 커스터마이징한 것이 라즈베리파이입니다**. 저게 절대 고정된 값이 아닙니다. 예를 들어, 라즈베리파이 재단에서는 GPIO[28,29]를 GPIO로 쓰고 있지만 우리는 저핀들을 I2C로 쓸 수 있습니다. 
![image](https://user-images.githubusercontent.com/29424805/216992140-7314e3bb-1dc2-4d7f-9653-caf0549edf95.png)

6. BMP180가 살아있는지 확인을 해봐야 합니다. 이런 과정을 `Bring-up`이라고 합니다. Bring-up은 보편적으로 해당 보드가 살아서 main chip과 통신이 되는 과정이라고 보면 됩니다.
